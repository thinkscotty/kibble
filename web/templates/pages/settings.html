{{define "title"}}Settings{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Settings</h1>
    {{if .Success}}<div class="alert alert-success">{{.Success}}</div>{{end}}
    {{if .Warning}}<div class="alert alert-warning">{{.Warning}}</div>{{end}}
</div>

<form hx-post="/settings" hx-target="body" hx-swap="outerHTML" hx-push-url="false">

    <!-- AI Provider -->
    <div class="card">
        <h3 class="card-title">AI Provider</h3>
        <p class="text-muted text-sm">Choose which AI provider to use for generating facts and summarizing news.</p>

        <div class="form-group form-group-sm">
            <label for="ai_provider">Primary AI Provider</label>
            <select id="ai_provider" name="ai_provider" class="form-input">
                <option value="gemini" {{if eq (index .Settings "ai_provider") "gemini"}}selected{{end}}>Gemini (Cloud)</option>
                <option value="chutes" {{if eq (index .Settings "ai_provider") "chutes"}}selected{{end}}>Chutes.ai (Cloud)</option>
                <option value="ollama" {{if eq (index .Settings "ai_provider") "ollama"}}selected{{end}}>Ollama (Local)</option>
            </select>
        </div>

        <hr style="border-color: var(--border); margin: 1rem 0;">

        <h4 style="margin-bottom: 0.5rem;">Gemini Configuration</h4>
        <p class="text-muted text-sm">Enter your Google Gemini Flash 2.5 free-tier API key. Get one from <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio</a>.</p>
        <div class="form-row">
            <div class="form-group">
                <label for="gemini_api_key">API Key</label>
                <input type="password" id="gemini_api_key" name="gemini_api_key"
                       value="{{index .Settings "gemini_api_key"}}"
                       placeholder="Enter your Gemini API key"
                       class="form-input">
            </div>
            <div class="form-group form-group-sm" style="align-self: flex-end;">
                <button type="button" class="btn btn-secondary"
                        hx-post="/settings/apikey/test"
                        hx-target="#apikey-test-result"
                        hx-include="[name='gemini_api_key']">
                    Test Key
                </button>
            </div>
        </div>
        <div id="apikey-test-result"></div>

        <hr style="border-color: var(--border); margin: 1rem 0;">

        <h4 style="margin-bottom: 0.5rem;">Chutes.ai Configuration</h4>
        <p class="text-muted text-sm">Connect to <a href="https://chutes.ai" target="_blank" rel="noopener">Chutes.ai</a> for access to 60+ open-source models. Get an API key from your Chutes.ai dashboard.</p>
        <div class="form-row">
            <div class="form-group">
                <label for="chutes_api_key">API Key</label>
                <input type="password" id="chutes_api_key" name="chutes_api_key"
                       value="{{index .Settings "chutes_api_key"}}"
                       placeholder="Enter your Chutes.ai API key"
                       class="form-input">
            </div>
            <div class="form-group form-group-sm" style="align-self: flex-end;">
                <button type="button" class="btn btn-secondary"
                        hx-post="/settings/chutes/test"
                        hx-target="#chutes-test-result"
                        hx-include="[name='chutes_api_key'],[name='chutes_model']">
                    Test Key
                </button>
            </div>
        </div>
        <div id="chutes-test-result"></div>
        <div class="form-group" style="margin-top: 0.5rem;">
            <label for="chutes_model">Model</label>
            <p class="text-muted text-sm">Enter the model identifier in <code>provider/model-name</code> format (e.g., <code>deepseek-ai/DeepSeek-V3</code>).</p>
            <input type="text" id="chutes_model" name="chutes_model"
                   value="{{index .Settings "chutes_model"}}"
                   placeholder="deepseek-ai/DeepSeek-V3"
                   class="form-input">
        </div>

        <hr style="border-color: var(--border); margin: 1rem 0;">

        <h4 style="margin-bottom: 0.5rem;">Ollama Configuration</h4>
        <p class="text-muted text-sm">Configure the Ollama server for local AI inference. Ollama must be running and accessible at the URL below.</p>
        <div class="form-row">
            <div class="form-group">
                <label for="ollama_url">Server URL</label>
                <input type="text" id="ollama_url" name="ollama_url"
                       value="{{index .Settings "ollama_url"}}"
                       placeholder="http://localhost:11434"
                       class="form-input">
            </div>
            <div class="form-group form-group-sm" style="align-self: flex-end;">
                <button type="button" class="btn btn-secondary"
                        hx-post="/settings/ollama/test"
                        hx-target="#ollama-test-result"
                        hx-include="[name='ollama_url']">
                    Test Connection
                </button>
            </div>
        </div>
        <div id="ollama-test-result"></div>
        <div class="form-row" style="margin-top: 0.5rem;">
            <div class="form-group">
                <label for="ollama_model">Default Model</label>
                <select id="ollama_model" name="ollama_model" class="form-input"
                        hx-get="/settings/ollama/models"
                        hx-trigger="load"
                        hx-target="this"
                        hx-swap="innerHTML"
                        hx-include="[name='ollama_url']">
                    <option value="{{index .Settings "ollama_model"}}">{{index .Settings "ollama_model"}}</option>
                </select>
            </div>
            <div class="form-group form-group-sm" style="align-self: flex-end;">
                <button type="button" class="btn btn-secondary"
                        hx-get="/settings/ollama/models"
                        hx-target="#ollama_model"
                        hx-swap="innerHTML"
                        hx-include="[name='ollama_url']">
                    Refresh Models
                </button>
            </div>
        </div>
    </div>

    <!-- AI Instructions (Facts) -->
    <div class="card">
        <h3 class="card-title">Facts AI Instructions</h3>
        <div class="form-group">
            <label for="ai_custom_instructions">Custom Instructions</label>
            <p class="text-muted text-sm">Guide the AI on what kind of facts to generate (e.g., "Focus on lesser-known facts", "Include recent discoveries").</p>
            <textarea id="ai_custom_instructions" name="ai_custom_instructions"
                      class="form-input form-textarea" rows="3"
                      placeholder="Optional: Guide the AI on fact selection...">{{index .Settings "ai_custom_instructions"}}</textarea>
        </div>
        <div class="form-group">
            <label for="ai_tone_instructions">Tone & Style</label>
            <p class="text-muted text-sm">Set the tone, length, and syntax of generated facts (e.g., "Keep facts concise, under 2 sentences", "Use a casual, friendly tone").</p>
            <textarea id="ai_tone_instructions" name="ai_tone_instructions"
                      class="form-input form-textarea" rows="3"
                      placeholder="Optional: Set the tone and style...">{{index .Settings "ai_tone_instructions"}}</textarea>
        </div>
    </div>

    <!-- AI Instructions (News/Stories) -->
    <div class="card">
        <h3 class="card-title">News AI Instructions</h3>
        <div class="form-group">
            <label for="news_sourcing_instructions">Source Discovery Instructions</label>
            <p class="text-muted text-sm">Guide the AI on what kinds of sources to find for news topics.</p>
            <textarea id="news_sourcing_instructions" name="news_sourcing_instructions"
                      class="form-input form-textarea" rows="3"
                      placeholder="Optional: Guide source discovery...">{{index .Settings "news_sourcing_instructions"}}</textarea>
        </div>
        <div class="form-group">
            <label for="news_summarizing_instructions">Summarizing Instructions</label>
            <p class="text-muted text-sm">Guide the AI on how to summarize news stories.</p>
            <textarea id="news_summarizing_instructions" name="news_summarizing_instructions"
                      class="form-input form-textarea" rows="3"
                      placeholder="Optional: Guide story summarization...">{{index .Settings "news_summarizing_instructions"}}</textarea>
        </div>
        <div class="form-group">
            <label for="news_tone_instructions">Tone & Style</label>
            <p class="text-muted text-sm">Set the tone, length, and style for summarized stories.</p>
            <textarea id="news_tone_instructions" name="news_tone_instructions"
                      class="form-input form-textarea" rows="3"
                      placeholder="Optional: Set the tone and style for stories...">{{index .Settings "news_tone_instructions"}}</textarea>
        </div>
    </div>

    <!-- Appearance -->
    <div class="card">
        <h3 class="card-title">Appearance</h3>
        <div class="form-row">
            <div class="form-group form-group-sm">
                <label for="theme_mode">Color Theme</label>
                <select id="theme_mode" name="theme_mode" class="form-input">
                    {{range .Themes}}
                    <option value="{{.ID}}" {{if eq .ID $.CurrentTheme}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-group form-group-sm">
                <label for="text_size">Text Size</label>
                <select id="text_size" name="text_size" class="form-input">
                    <option value="small" {{if eq (index .Settings "text_size") "small"}}selected{{end}}>Small</option>
                    <option value="medium" {{if eq (index .Settings "text_size") "medium"}}selected{{end}}>Medium</option>
                    <option value="large" {{if eq (index .Settings "text_size") "large"}}selected{{end}}>Large</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div class="card">
        <h3 class="card-title">Dashboard Layout</h3>
        <div class="form-row">
            <div class="form-group form-group-sm">
                <label for="card_columns">Card Columns</label>
                <select id="card_columns" name="card_columns" class="form-input">
                    <option value="1" {{if eq (index .Settings "card_columns") "1"}}selected{{end}}>1</option>
                    <option value="2" {{if eq (index .Settings "card_columns") "2"}}selected{{end}}>2</option>
                    <option value="3" {{if eq (index .Settings "card_columns") "3"}}selected{{end}}>3</option>
                    <option value="4" {{if eq (index .Settings "card_columns") "4"}}selected{{end}}>4</option>
                </select>
            </div>
            <div class="form-group form-group-sm">
                <label for="facts_per_topic_display">Facts Per Topic</label>
                <input type="number" id="facts_per_topic_display" name="facts_per_topic_display"
                       value="{{index .Settings "facts_per_topic_display"}}" min="1" max="50" class="form-input">
            </div>
            <div class="form-group form-group-sm">
                <label for="stories_per_topic_display">Stories Per Topic</label>
                <input type="number" id="stories_per_topic_display" name="stories_per_topic_display"
                       value="{{index .Settings "stories_per_topic_display"}}" min="1" max="50" class="form-input">
            </div>
            <div class="form-group form-group-sm">
                <label for="similarity_threshold">Similarity Threshold</label>
                <input type="number" id="similarity_threshold" name="similarity_threshold"
                       value="{{index .Settings "similarity_threshold"}}" min="0" max="1" step="0.05" class="form-input">
            </div>
        </div>
    </div>

    <!-- External API Key -->
    <div class="card">
        <h3 class="card-title">External API Key</h3>
        <p class="text-muted text-sm">Required by external client devices to access the <code>/api/v1/</code> endpoints.
           Pass as <code>Authorization: Bearer &lt;key&gt;</code> header or <code>?api_key=&lt;key&gt;</code> query parameter.</p>
        <div class="form-row" style="align-items: center;">
            <div class="form-group">
                <label>API Key</label>
                <code id="api-key-value" style="word-break: break-all;">{{index .Settings "api_key"}}</code>
            </div>
            <div class="form-group form-group-sm" style="align-self: flex-end;">
                <button type="button" class="btn btn-secondary"
                        hx-post="/settings/apikey/regenerate"
                        hx-target="#api-key-value"
                        hx-swap="outerHTML"
                        hx-confirm="Regenerate API key? External clients will need the new key.">
                    Regenerate
                </button>
            </div>
        </div>
    </div>

    <!-- Update Kibble -->
    <div class="card">
        <h3 class="card-title">Update Kibble</h3>
        <p class="text-muted text-sm">
            Current version: <strong>{{.Version}}</strong>
            {{if ne .BuildTime "unknown"}} &middot; Built {{.BuildTime}}{{end}}
        </p>
        <div style="margin-top: 0.75rem;">
            <button type="button" class="btn btn-secondary"
                    hx-post="/settings/update/check"
                    hx-target="#update-result"
                    hx-swap="innerHTML">
                Check for Updates
            </button>
        </div>
        <div id="update-result" style="margin-top: 0.75rem;"></div>
    </div>

    <div class="form-actions-footer">
        <button type="submit" class="btn btn-primary btn-lg">Save Settings</button>
    </div>
</form>
{{end}}
