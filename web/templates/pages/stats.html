{{define "title"}}Statistics{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Statistics</h1>
</div>

<!-- Facts Stats -->
<div class="card">
    <h3 class="card-title">Facts</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalTopics}}</div>
            <div class="stat-label">Total Topics</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.ActiveTopics}}</div>
            <div class="stat-label">Active Topics</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalFacts}}</div>
            <div class="stat-label">Total Facts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.AIGeneratedFacts}}</div>
            <div class="stat-label">AI-Generated</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.CustomFacts}}</div>
            <div class="stat-label">Custom Facts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.FactsDiscarded}}</div>
            <div class="stat-label">Discarded (Similar)</div>
        </div>
    </div>
</div>

<!-- News Stats -->
<div class="card">
    <h3 class="card-title">News</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalNewsTopics}}</div>
            <div class="stat-label">News Topics</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.ActiveNewsTopics}}</div>
            <div class="stat-label">Active News Topics</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalStories}}</div>
            <div class="stat-label">Total Stories</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalNewsSources}}</div>
            <div class="stat-label">Total Sources</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.ActiveNewsSources}}</div>
            <div class="stat-label">Active Sources</div>
        </div>
    </div>
</div>

<!-- General Stats -->
<div class="card">
    <h3 class="card-title">General</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalAPIRequests}}</div>
            <div class="stat-label">API Requests</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalTokensUsed}}</div>
            <div class="stat-label">Tokens Used</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{formatBytes .Stats.DatabaseSizeBytes}}</div>
            <div class="stat-label">Database Size</div>
        </div>
    </div>
</div>

<!-- Recent API Usage -->
<div class="card">
    <h3 class="card-title">Recent API Activity</h3>
    {{if .RecentUsage}}
    <div class="table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>Topic</th>
                    <th>Requested</th>
                    <th>Generated</th>
                    <th>Discarded</th>
                    <th>Tokens</th>
                    <th>Status</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {{range .RecentUsage}}
                <tr>
                    <td>{{.TopicName}}</td>
                    <td>{{.FactsRequested}}</td>
                    <td>{{.FactsGenerated}}</td>
                    <td>{{.FactsDiscarded}}</td>
                    <td>{{.TokensUsed}}</td>
                    <td>
                        {{if .ErrorMessage}}
                            <span class="badge badge-error" title="{{.ErrorMessage}}">Error</span>
                        {{else}}
                            <span class="badge badge-active">OK</span>
                        {{end}}
                    </td>
                    <td class="text-muted text-sm">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <p class="text-muted">No API activity yet.</p>
    {{end}}
</div>

<!-- Refresh Activity Log -->
<div class="card">
    <h3 class="card-title">Refresh Activity Log</h3>
    {{if .RefreshLogs}}
    <div class="table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>Topic</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Error</th>
                    <th>Duration</th>
                    <th>Provider</th>
                    <th>Items</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {{range .RefreshLogs}}
                <tr>
                    <td>{{.TopicName}}</td>
                    <td>
                        {{if eq .TopicType "facts"}}
                            <span class="badge badge-topic">Facts</span>
                        {{else}}
                            <span class="badge badge-ai-source">News</span>
                        {{end}}
                    </td>
                    <td>
                        {{if eq .Status "success"}}
                            <span class="badge badge-active">OK</span>
                        {{else}}
                            <span class="badge badge-error">Error</span>
                        {{end}}
                    </td>
                    <td>
                        {{if .ErrorMessage}}
                            <span class="text-sm text-error" title="{{.ErrorMessage}}" style="max-width: 250px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle;">{{.ErrorMessage}}</span>
                        {{else if .ErrorType}}
                            <span class="text-sm text-muted">{{.ErrorType}}</span>
                        {{else}}
                            <span class="text-muted text-sm">—</span>
                        {{end}}
                    </td>
                    <td class="text-sm">{{printf "%.1fs" (divFloat .DurationMs 1000)}}</td>
                    <td class="text-sm">{{if .AIProvider}}{{.AIProvider}}{{else}}<span class="text-muted">—</span>{{end}}</td>
                    <td>{{.ItemCount}}</td>
                    <td class="text-muted text-sm">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <p class="text-muted">No refresh activity yet.</p>
    {{end}}
</div>
{{end}}
